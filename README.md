# hash-zig

[![CI](https://github.com/ch4r10t33r/hash-zig/actions/workflows/ci.yml/badge.svg)](https://github.com/ch4r10t33r/hash-zig/actions/workflows/ci.yml)
[![Zig](https://img.shields.io/badge/zig-0.14.1-orange.svg)](https://ziglang.org/)
[![License](https://img.shields.io/badge/license-Apache%202.0-blue.svg)](LICENSE)

Pure Zig implementation of **Generalized XMSS** signatures with wire-compatible behavior against the Rust reference implementation ([hash-sig](https://github.com/b-wagn/hash-sig)). Keys, signatures, and Merkle paths interchange freely between the two ecosystems for lifetimes `2^8`, `2^18`, and (experimental) `2^32`.

## Highlights

- **Protocol fidelity** – Poseidon2 hashing, ShakePRF domain separation, target sum encoding, and Merkle construction match the Rust reference bit-for-bit.
- **Multiple lifetimes** – `2^8`, `2^18`, `2^32` signatures per key with configurable activation windows (defaults to 256 epochs).
- **Interop-first CI** – the default workflow runs same-language and cross-language checks for lifetimes `2^8` and `2^18`.
- **Pure Zig** – minimal dependencies, explicit memory management, ReleaseFast-ready.

## Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [Cross-Language Compatibility Tests](#cross-language-compatibility-tests)
- [Development](#development)
- [License](#license)

## Installation

### Using the Zig package manager

`build.zig.zon`:

```zig
.{
    .name = "my_project",
    .version = "0.1.0",
    .dependencies = .{
        .@"hash-zig" = .{
            .url = "https://github.com/ch4r10t33r/hash-zig/archive/refs/tags/v2.0.0.tar.gz",
            .hash = "1220...", // generated by zig build
        },
        .@"zig-poseidon" = .{
            .url = "https://github.com/blockblaz/zig-poseidon/archive/refs/heads/main.tar.gz",
            .hash = "1220...", // generated by zig build
        },
    },
}
```

`build.zig`:

```zig
const hash_zig_dep = b.dependency("hash-zig", .{ .target = target, .optimize = optimize });
const zig_poseidon_dep = b.dependency("zig_poseidon", .{ .target = target, .optimize = optimize });

exe.root_module.addImport("hash-zig", hash_zig_dep.module("hash-zig"));
exe.root_module.addImport("poseidon", zig_poseidon_dep.module("poseidon"));
```

### Manual

```bash
git clone https://github.com/ch4r10t33r/hash-zig.git
cd hash-zig
zig build test
```

## Quick Start

```zig
const std = @import("std");
const hash_zig = @import("hash-zig");

pub fn main() !void {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer _ = gpa.deinit();
    const allocator = gpa.allocator();

    var scheme = try hash_zig.GeneralizedXMSSSignatureScheme.init(allocator, .lifetime_2_8);
    defer scheme.deinit();

    const keypair = try scheme.keyGen(0, 256);
    defer keypair.secret_key.deinit();

    const message = [_]u8{0x42} ** 32;
    const signature = try scheme.sign(keypair.secret_key, 0, message);
    defer signature.deinit();

    const ok = try scheme.verify(&keypair.public_key, 0, message, signature);
    std.debug.print("Signature valid: {}\n", .{ok});
}
```

> For lifetimes `2^18` and `2^32`, compile with `zig build -Doptimize=ReleaseFast`.

## Cross-Language Compatibility Tests

CI runs four matrices (Zig→Zig, Zig→Rust, Rust→Rust, Rust→Zig) for lifetimes `2^8` and `2^18` with 256 active epochs. To reproduce locally:

### Prerequisites

```bash
zig build                                      # builds Zig helpers (zig-sign-message, zig-verify-signature, ...)
cargo build --manifest-path benchmark/rust_benchmark/Cargo.toml --bins
```

### Lifetime 2^8

```bash
# Zig → Zig
ZIG_GLOBAL_CACHE_DIR=$PWD/.zig-cache \
  MESSAGE="interop 2^8" EPOCH=0 LIFETIME="2^8" NUM_ACTIVE_EPOCHS=256 \
  ./zig-out/bin/zig-sign-message > tmp/zig_2_8.log

PUBLIC_KEY="PUBLIC_KEY:$(grep '^PUBLIC_KEY:' tmp/zig_2_8.log | cut -d: -f2-)" \
SIGNATURE="SIGNATURE:$(grep '^SIGNATURE:' tmp/zig_2_8.log | cut -d: -f2-)" \
MESSAGE="interop 2^8" EPOCH=0 LIFETIME="2^8" NUM_ACTIVE_EPOCHS=256 \
./zig-out/bin/zig-verify-signature

# Zig → Rust
PUBLIC_KEY="$(grep '^PUBLIC_KEY:' tmp/zig_2_8.log | cut -d: -f2-)" \
SIGNATURE="$(grep '^SIGNATURE:' tmp/zig_2_8.log | cut -d: -f2-)" \
MESSAGE="interop 2^8" EPOCH=0 \
cargo run --manifest-path benchmark/rust_benchmark/Cargo.toml --bin verify_signature

# Rust → Zig
MESSAGE="interop 2^8" EPOCH=0 \
cargo run --manifest-path benchmark/rust_benchmark/Cargo.toml --bin sign_message \
  > tmp/rust_2_8.log

PUBLIC_KEY="PUBLIC_KEY:$(grep '^PUBLIC_KEY:' tmp/rust_2_8.log | cut -d: -f2-)" \
SIGNATURE="SIGNATURE:$(grep '^SIGNATURE:' tmp/rust_2_8.log | cut -d: -f2-)" \
MESSAGE="interop 2^8" EPOCH=0 LIFETIME="2^8" NUM_ACTIVE_EPOCHS=256 \
./zig-out/bin/zig-verify-signature
```

For lifetime `2^18`, change `LIFETIME="2^18"` and switch the Rust binaries to `verify_signature_2_18` / `sign_message_2_18`. Each command should print `VERIFY_RESULT:true`.

> **Work in progress:** Lifetime `2^32` mirrors the workflow above and will be formalised once validation completes.

### CI Reference

The compatibility logic lives in `.github/workflows/ci.yml` (“Run compatibility matrix (2^8 & 2^18)” step) and can be used as a reference shell script.

## Development

Key commands:

```bash
zig build                 # build library and helper binaries
zig build lint            # format check
zig build test            # unit + integration tests
zig build test-rust-compat # Zig↔Rust compatibility unit tests
cargo build --manifest-path benchmark/rust_benchmark/Cargo.toml --bins
```

Repository layout:

```
src/            # core library
examples/       # usage + compatibility demos
benchmark/      # Rust + Zig benchmarking utilities
investigations/ # exploratory scripts
.github/        # workflows (CI compatibility matrix lives here)
```

## License

Licensed under the Apache License 2.0 – see [LICENSE](LICENSE).

### Acknowledgments

- [hash-sig](https://github.com/b-wagn/hash-sig) — original Rust implementation and reference tests
- [zig-poseidon](https://github.com/blockblaz/zig-poseidon) — Poseidon2 over the KoalaBear field
- [Generalized XMSS (ePrint 2025/055)](https://eprint.iacr.org/2025/055.pdf) — scheme specification
- [Rust ↔ Zig compatibility investigation](analysis/rust_zig_compatibility_investigation.md)