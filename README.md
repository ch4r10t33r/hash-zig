# hash-zig

[![CI](https://github.com/blockblaz/hash-zig/actions/workflows/ci.yml/badge.svg)](https://github.com/blockblaz/hash-zig/actions/workflows/ci.yml)
[![Zig](https://img.shields.io/badge/zig-0.14.1-orange.svg)](https://ziglang.org/)
[![License](https://img.shields.io/badge/license-Apache%202.0-blue.svg)](LICENSE)

Pure Zig implementation of **Generalized XMSS** signatures with wire-compatible behavior against the Rust reference implementation ([leanSig](https://github.com/leanEthereum/leanSig)). Keys, signatures, and Merkle paths interchange freely between the two ecosystems for lifetimes `2^8`, `2^18`, and (experimental) `2^32`.

**⚠️ Prototype Status**: This is a prototype implementation for research and development purposes. Use at your own risk.

- **Protocol fidelity** – Poseidon2 hashing, ShakePRF domain separation, target sum encoding, and Merkle construction match the Rust reference bit-for-bit.
- **Multiple lifetimes** – `2^8`, `2^18`, `2^32` signatures per key with configurable activation windows (defaults to 256 epochs).
- **Interop-first CI & tooling** – `github/workflows/ci.yml` runs `benchmark/benchmark.py`, covering same-language and cross-language checks for lifetimes `2^8` and `2^18`. Locally, pick lifetimes via `--lifetime` (e.g. `2^32`) and enable verbose logs only when needed with `BENCHMARK_DEBUG_LOGS=1`.
- **Pure Zig** – minimal dependencies, explicit memory management, ReleaseFast-ready.

## Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [Cross-Language Compatibility Tests](#cross-language-compatibility-tests)
- [Debug Logging](#debug-logging)
- [Development](#development)
- [License](#license)

## Installation

### Using the Zig package manager

`build.zig.zon`:

```zig
.{
    .name = "my_project",
    .version = "0.1.0",
    .dependencies = .{
        .@"hash-zig" = .{
            .url = "https://github.com/ch4r10t33r/hash-zig/archive/refs/tags/v2.0.0.tar.gz",
            .hash = "1220...", // generated by zig build
        },
        .@"zig-poseidon" = .{
            .url = "https://github.com/blockblaz/zig-poseidon/archive/refs/heads/main.tar.gz",
            .hash = "1220...", // generated by zig build
        },
    },
}
```

`build.zig`:

```zig
const hash_zig_dep = b.dependency("hash-zig", .{ .target = target, .optimize = optimize });
const zig_poseidon_dep = b.dependency("zig_poseidon", .{ .target = target, .optimize = optimize });

exe.root_module.addImport("hash-zig", hash_zig_dep.module("hash-zig"));
exe.root_module.addImport("poseidon", zig_poseidon_dep.module("poseidon"));
```

### Manual

```bash
git clone https://github.com/ch4r10t33r/hash-zig.git
cd hash-zig
zig build test
```

## Quick Start

```zig
const std = @import("std");
const hash_zig = @import("hash-zig");

pub fn main() !void {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer _ = gpa.deinit();
    const allocator = gpa.allocator();

    var scheme = try hash_zig.GeneralizedXMSSSignatureScheme.init(allocator, .lifetime_2_8);
    defer scheme.deinit();

    const keypair = try scheme.keyGen(0, 256);
    defer keypair.secret_key.deinit();

    const message = [_]u8{0x42} ** 32;
    const signature = try scheme.sign(keypair.secret_key, 0, message);
    defer signature.deinit();

    const ok = try scheme.verify(&keypair.public_key, 0, message, signature);
    std.debug.print("Signature valid: {}\n", .{ok});
}
```

> For lifetimes `2^18` and `2^32`, compile with `zig build -Doptimize=ReleaseFast`.

## Cross-Language Compatibility Tests

The repository ships a helper script `benchmark/benchmark.py` that exercises both implementations (Zig ↔ Rust) in ReleaseFast mode. By default it performs:

- deterministic key generation for lifetimes `2^8` and `2^18` with 256 active epochs
- signing with each implementation
- verification by both implementations (self + cross)
- timing and artifact summaries written to `/tmp`

Verbose hash-level traces are suppressed unless you opt in with `BENCHMARK_DEBUG_LOGS=1`.

### Prerequisites

```bash
python3 --version  # Python 3.8+
zig version        # 0.14.1
cargo --version    # Rust 1.87.0 toolchain (matches CI)
```

### Run the suite (recommended)

```bash
# Produce zig-out/bin/zig-remote-hash-tool (ReleaseFast) and rust_benchmark/target/release/remote_hashsig_tool
python3 benchmark/benchmark.py                             # runs lifetimes 2^8 and 2^18
python3 benchmark/benchmark.py --lifetime 2^32             # runs lifetime 2^32 only
python3 benchmark/benchmark.py --lifetime "2^8,2^18,2^32"   # runs all lifetimes sequentially
# Enable verbose cross-implementation debug logs
BENCHMARK_DEBUG_LOGS=1 python3 benchmark/benchmark.py --lifetime 2^8
```

The script automatically:

1. Builds the Zig helper with `zig build zig-remote-hash-tool -Doptimize=ReleaseFast`
2. Builds the Rust helper in `--release`
3. Runs Zig→Zig, Zig→Rust, Rust→Rust, Rust→Zig checks for the requested lifetimes
4. Reports PASS/FAIL and timing information for each leg, plus the artifact paths in `/tmp/rust_public_*` and `/tmp/zig_public_*`

### CI Reference

The compatibility logic lives in `.github/workflows/ci.yml` (“Run compatibility matrix (2^8 & 2^18)” step) and can be used as a reference shell script.

### Run locally (quick reference)

```bash
# lifetimes 2^8 and 2^18
python3 benchmark/benchmark.py

# lifetime 2^32 (longer run)
python3 benchmark/benchmark.py --lifetime 2^32

# include verbose Rust/Zig debug traces
BENCHMARK_DEBUG_LOGS=1 python3 benchmark/benchmark.py --lifetime 2^8
```

The script prints a PASS/FAIL matrix, timings, and the artifact locations under `/tmp`. Delete the files between runs if you want a clean slate: `rm /tmp/*_public_* /tmp/*_signature_*`.

## Debug Logging

The hash-zig library includes extensive debug logging that can impact performance. All debug logging is controlled by a build-time feature flag `enable_debug_logs` that defaults to `false`.

### Default Behavior (Debug Logs Disabled)

By default, debug logs are **disabled** for optimal performance:

```bash
# Debug logs disabled (default)
zig build test-lifetimes
zig build test-lifetimes -OReleaseFast
```

### Enable Debug Logs

To enable debug logs for debugging purposes:

```bash
# Enable debug logs
zig build test-lifetimes -Ddebug-logs=true
zig build test-lifetimes -OReleaseFast -Ddebug-logs=true
```

### Performance Impact

When debug logs are disabled (default):
- **Zero overhead**: The `log.print()` function returns immediately
- **Compiler optimization**: In ReleaseFast builds, the check is optimized away
- **Clean output**: No debug noise in benchmark results

When debug logs are enabled:
- **Full logging**: All debug statements are printed
- **Performance impact**: String formatting and I/O operations add overhead
- **Useful for debugging**: Helps trace execution flow and identify issues

### Benchmarking Best Practices

**For Performance Benchmarks:**

Always run benchmarks **without** debug logs:

```bash
# Recommended for benchmarking
zig build test-lifetimes -OReleaseFast

# Or explicitly disable (though it's default)
zig build test-lifetimes -OReleaseFast -Ddebug-logs=false
```

**For Debugging:**

Enable debug logs when investigating issues:

```bash
# Enable debug logs for debugging
zig build test-lifetimes -Ddebug-logs=true

# Or with ReleaseFast for performance debugging
zig build test-lifetimes -OReleaseFast -Ddebug-logs=true
```

### Debug Log Categories

The following debug log prefixes are used:

- `ZIG_SIGN_DEBUG`: Signing operation debug logs
- `ZIG_VERIFY_DEBUG`: Verification operation debug logs
- `ZIG_HASH_CALL`: Hash function call logs
- `ZIG_HASH_RESULT`: Hash function result logs
- `ZIG_BUILDTREE`: Tree building debug logs
- `ZIG_BOTTOM_ROOT`: Bottom tree root computation logs
- `DEBUG:`: General debug messages

### Example

```bash
# Run benchmark without debug logs (fast, clean output)
$ zig build test-lifetimes -OReleaseFast
Testing Lifetime: 2^8
⏱️  Key Generation Time: 1.671 seconds
   ✅ Epoch 0: Sign=279.105ms, Verify=1.099ms
   ✅ Epoch 1: Sign=4.586ms, Verify=1.086ms
...

# Run with debug logs (verbose, slower)
$ zig build test-lifetimes -OReleaseFast -Ddebug-logs=true
Testing Lifetime: 2^8
ZIG_SIGN_DEBUG: Reusing 4 bottom tree layers from stored tree...
ZIG_HASH_CALL: level=0 pos=8 tweak=0x...
DEBUG: Tree tweak level=1 pos=8 -> 0x...
⏱️  Key Generation Time: 1.671 seconds
...
```

### Summary

- ✅ **Default**: Debug logs are **disabled** for optimal performance
- ✅ **Benchmarking**: Use default (no debug logs) for accurate performance measurements
- ✅ **Debugging**: Use `-Ddebug-logs=true` when investigating issues
- ✅ **Zero overhead**: When disabled, logging has no performance impact

## Performance Benchmarks

Performance measurements are taken using `zig build test-lifetimes` with ReleaseFast optimization. All benchmarks are run with debug logging disabled for accurate performance measurements.

### Lifetime 2^32 (1024 Active Epochs)

**Key Generation:**
- Time: **666.726 seconds** (~11.1 minutes)

**Signing Performance (5 epochs tested):**
- Average: **164.715 ms**
- Min: **16.543 ms** (epoch 1)
- Max: **578.319 ms** (epoch 0)

**Verification Performance (5 epochs tested):**
- Average: **4.510 ms**
- Min: **4.340 ms**
- Max: **4.638 ms**

> **Note**: Key generation time scales roughly linearly with the number of active epochs. Using 256 active epochs instead of 1024 reduces key generation time to approximately **166-170 seconds** (~2.8 minutes), about 1/4 the time.

### Running Benchmarks

To run benchmarks for specific lifetimes:

```bash
# Lifetime 2^8 and 2^18 (default)
zig build test-lifetimes

# Lifetime 2^32 (requires flag)
zig build test-lifetimes -Denable-lifetime-2-32=true

# Using benchmark scripts for formatted output
bash scripts/benchmark_lifetime_2_32.sh
bash scripts/benchmark_lifetime_2_18.sh
bash scripts/benchmark_lifetime_2_8.sh
```

All benchmarks are automatically built in ReleaseFast mode for accurate performance measurements.

## Development

Key commands:

```bash
zig build                 # build library and helper binaries
zig build lint            # format check
zig build test            # unit + integration tests
zig build test-rust-compat # Zig↔Rust compatibility unit tests
cargo build --manifest-path benchmark/rust_benchmark/Cargo.toml --bins
```

Repository layout:

```
src/            # core library
examples/       # usage + compatibility demos
benchmark/      # Rust + Zig benchmarking utilities
investigations/ # exploratory scripts
.github/        # workflows (CI compatibility matrix lives here)
```

## License

Licensed under the Apache License 2.0 – see [LICENSE](LICENSE).

### Acknowledgments

- [leanSig](https://github.com/leanEthereum/leanSig) — original Rust implementation and reference tests
- [zig-poseidon](https://github.com/blockblaz/zig-poseidon) — Poseidon2 over the KoalaBear field
- [Generalized XMSS (ePrint 2025/055)](https://eprint.iacr.org/2025/055.pdf) — scheme specification
- [Rust ↔ Zig compatibility investigation](analysis/rust_zig_compatibility_investigation.md)