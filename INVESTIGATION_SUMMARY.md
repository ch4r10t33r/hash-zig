# Investigation Summary: Zig vs Rust Public Key Discrepancy

## ‚úÖ **What's Working:**

1. **RNG Initialization** ‚úÖ
   - Both Rust and Zig use same seed: `0x42` repeated 32 times
   - ChaCha12Rng implementation matches exactly

2. **Parameter Generation** ‚úÖ
   - Parameters match exactly: `[1128497561, 1847509114, 1994249188, 1874424621, 1302548296]`
   - Fixed issue: Added `>> 1` to generate 31-bit field elements

3. **PRF Key Generation** ‚úÖ
   - PRF keys match exactly: `7e26e9c388d12be81790ccc932424b20db4e16b96260ac406e212b3625149ead`

4. **Poseidon2 Hash Function** ‚úÖ
   - All Poseidon2 tests pass with identical outputs
   - Internal layer logic matches Plonky3 Rust implementation

5. **RNG State Management** ‚úÖ
   - Fixed critical bug: `getRngState()` was consuming RNG state
   - Schemes are now truly independent with proper RNG synchronization

6. **Benchmark Seed Initialization** ‚úÖ
   - Fixed issue: Benchmark was using random timestamp seed
   - Now uses fixed seed via `initWithSeed()`

## ‚ùå **What's Not Working:**

### **Public Key Roots Differ:**
- **Rust root**: `[272571317, 816959513, 1641229267, 1432426756, 1894915310, 1536602969, 679245493, 946325787]`
- **Zig root**: `[706727879, 1331349382, 277585992, 1593461259, 604906830, 2055314519, 1348387516, 1753236472]`

### **Possible Causes:**

1. **Bottom Tree Generation:**
   - Zig bottom tree roots (first element): `[0x1640cb16, 0x54503ce2, 0x7e118cb3, 0x6aeeecb5, 0x4ea08a17, 0x2c138707, 0x65d14fc6, 0x2c5e70b5, 0x30ff8f32, 0x59e166e4, 0x7e8fc675, 0x60080f45, 0x5bbb59d8, 0x5d5742ec, 0x1e0d8135, 0x4915976b]`
   - Need to compare with Rust bottom tree roots to see if they match

2. **Top Tree Building:**
   - Even if bottom trees match, the top tree building algorithm might differ
   - Padding logic, hash application, or tweak encoding could be different

3. **Domain Element Generation:**
   - The PRF might be generating different domain elements
   - Need to verify `ShakePRFtoF_8_7.getDomainElement` matches Rust exactly

4. **Chain Computation:**
   - The hash chain computation might differ
   - Need to verify `computeHashChain` matches Rust exactly

## üìã **Next Steps:**

1. **Add Rust Debug Output:**
   - Modify hash-sig crate or add debug output to compare bottom tree roots directly

2. **Compare Bottom Tree Roots:**
   - Verify if the 16 bottom tree roots match between Rust and Zig
   - If they match, the issue is in top tree building
   - If they don't match, the issue is in bottom tree generation

3. **Debug PRF Output:**
   - Compare domain elements generated by `ShakePRFtoF_8_7.getDomainElement`
   - Verify they match exactly between Rust and Zig

4. **Debug Chain Computation:**
   - Compare chain end values for each epoch
   - Verify `computeHashChain` matches Rust exactly

5. **Debug Tree Building Step-by-Step:**
   - Compare intermediate tree nodes during top tree construction
   - Verify padding, hash application, and tweak encoding match exactly

## üéØ **Goal:**

Both Rust and Zig implementations should generate the **same public key** for a given seed and lifetime.

**Status**: Investigation ongoing. Parameters and PRF keys match, but public key roots differ. Need to compare bottom tree roots and debug tree building algorithm.

